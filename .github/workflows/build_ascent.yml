name: build_ascent

on:
  pull_request:
    branches: [ develop ]

jobs:
  build_pip_basic:
    strategy:
      matrix:
        include:
        - cc: gcc
          cxx: g++
          fc: gfortran
        - cc: icc
          cxx: icpc
          fc: ifort
        - cc: icx
          cxx: icpx
          fc: ifx
    name: Ubuntu Build Ascent (${{ matrix.cc }})
    runs-on: ubuntu-latest
    steps:
    - name: Install System Deps
      run: |
           sudo apt-get update
           sudo apt-get install binutils \
                                gcc \
                                g++ \
                                gfortran \
                                python \
                                perl \
                                git \
                                git-lfs \
                                curl \
                                wget \
                                tar \
                                unzip \
                                build-essential \
                                libncurses-dev \
                                libssl-dev \
                                libblas-dev \
                                liblapack-dev \
                                zlib1g-dev \
                                libgdbm-dev \
                                libreadline-dev \
                                libsqlite3-dev \
                                libbz2-dev \
                                mpich \
                                libmpich-dev \
                                cmake
    - name: Install intel compilers
      if: ${{ matrix.cc == "icx" || matrix.cc == "icc" }}
      run: |
        wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB \
          | gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /devnull
        echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | \
          sudo tee /etc/apt/sources.list.d/oneAPI.list > /dev/null
        sudo apt-get update
        sudo apt install -y intel-oneapi-compiler-dpcpp-cpp-and-cpp-classic \
                       intel-oneapi-compiler-fortran
    - name: Checkout
      uses: actions/checkout@v2
      with:
        submodules: 'recursive'
    - name: Build TPLs
      run: |
        env enable_mpi=ON \
            enable_fortran=ON \
            enable_tests=OFF \
            build_ascent=OFF \
            enable_verbose=OFF \
            build_jobs=2 \
            ./scripts/build_ascent/build_ascent.sh
    - name: Build Ascent
      run: |
        echo "**** Configuring Ascent"
        export CC=${{ matrix.cc }}
        export CXX=${{ matrix.cxx }}
        export FC=${{ matrix.fc }}
        [${CC} == "icx" || ${CC} == "icc"] || source /opt/intel/oneapi/setvars.sh
        cmake -S src -B build -C ascent-config.cmake
    - name: Build Ascent
      run: |
        echo "**** Building Ascent"
        export CC=${{ matrix.cc }}
        export CXX=${{ matrix.cxx }}
        export FC=${{ matrix.fc }}
        [${CC} == "icx" || ${CC} == "icc"] || source /opt/intel/oneapi/setvars.sh
        cmake --build  build -j2
    - name: Install Ascent
      run: |
        echo "**** Installing Ascent"
        cmake --install  build


